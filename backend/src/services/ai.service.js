import { GoogleGenerativeAI } from '@google/generative-ai';
import { AI_CONFIG, MITA_PERSONALITY } from '../config/ai.config.js';

/**
 * Base AI Provider Class
 */
class AIProvider {
    async generateResponse(params) {
        throw new Error('Method generateResponse must be implemented');
    }
}



/**
 * Gemini Provider Implementation
 */
class GeminiProvider extends AIProvider {
    constructor(apiKey) {
        super();
        this.genAI = apiKey ? new GoogleGenerativeAI(apiKey) : null;
    }

    async generateResponse({ model, systemInstruction, history, message, options = {} }) {
        if (!this.genAI) throw new Error('Gemini API key not configured');

        const modelId = model || AI_CONFIG.DEFAULT_MODEL || 'gemini-1.5-flash';

        try {
            const genModel = this.genAI.getGenerativeModel({
                model: modelId,
                generationConfig: {
                    ...AI_CONFIG.GENERATION_DEFAULTS,
                    ...options
                },
                systemInstruction: systemInstruction,
            });

            const chat = genModel.startChat({
                history: history.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.content }]
                })),
            });

            const result = await chat.sendMessage(message);
            const response = await result.response;

            return {
                text: response.text(),
                usage: {
                    inputTokens: response.usageMetadata?.promptTokenCount || 0,
                    outputTokens: response.usageMetadata?.candidatesTokenCount || 0,
                }
            };
        } catch (error) {
            console.error(`[GEMINI] Model ${modelId} failed:`, error.message);
            throw error;
        }
    }
}

/**
 * AI Service Facade
 */
class AIService {
    constructor() {
        const key = AI_CONFIG.PROVIDERS.GEMINI.apiKey;
        const keyStatus = key ? `Loaded (${key.substring(0, 10)}...)` : 'Not Found';
        console.log(`[MITA NEURAL LINK] Gemini Key: ${keyStatus}`);

        this.providers = {
            gemini: new GeminiProvider(AI_CONFIG.PROVIDERS.GEMINI.apiKey),
        };

        // Original expert knowledge for instant responses
        this.EXPERT_KNOWLEDGE = {
            react: `üöÄ **React & Frontend**
            
React ‚Äî —ç—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ —Å –ø–æ–º–æ—â—å—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.
- **Components**: –°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ —Ç–≤–æ–µ–≥–æ UI.
- **Hooks**: useState –¥–ª—è –¥–∞–Ω–Ω—ã—Ö, useEffect –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π.
- **Props**: –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏.

–ß–µ–º –∏–º–µ–Ω–Ω–æ –ø–æ–º–æ—á—å –≤ React?`,

            python: `üêç **Python - –¢–≤–æ–π –ø—É—Ç—å –≤ –∫–æ–¥**
            
Python –ø—Ä–æ—Å—Ç –∏ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ —Å–∏–ª–µ–Ω.
- **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**: –•—Ä–∞–Ω—è—Ç –¥–∞–Ω–Ω—ã–µ.
- **–°–ø–∏—Å–∫–∏ –∏ –°–ª–æ–≤–∞—Ä–∏**: –û—Ä–≥–∞–Ω–∏–∑—É—é—Ç –∏—Ö.
- **–§—É–Ω–∫—Ü–∏–∏**: –ü–æ–∑–≤–æ–ª—è—é—Ç –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è.

–•–æ—á–µ—à—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –ø—Ä–∏–º–µ—Ä –∏–ª–∏ —Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É?`,

            javascript: `‚ö° **JavaScript - –°–µ—Ä–¥—Ü–µ –≤–µ–±–∞**
            
JS –¥–µ–ª–∞–µ—Ç —Å–∞–π—Ç—ã –∂–∏–≤—ã–º–∏.
- **ES6+**: –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã (—Å—Ç—Ä–µ–ª–æ—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –¥–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è).
- **DOM**: –ú–∞–Ω–∏–ø—É–ª—è—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ.
- **Async**: –†–∞–±–æ—Ç–∞ —Å —Å–µ—Ç—å—é —á–µ—Ä–µ–∑ fetch –∏–ª–∏ axios.`,

            figma: `üé® **Figma - –¢–≤–æ–π –¥–∏–∑–∞–π–Ω-—Ü–µ–Ω—Ç—Ä**
            
- **Auto Layout**: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å.
- **Components**: –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤.
- **Variants**: –°–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –∏ –ø–æ–ª–µ–π.`,

            git: `üìÇ **Git - –ö–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π**
            
- **commit**: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å.
- **push**: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
- **pull**: –ó–∞–±—Ä–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.`,

            "–ø—Ä–∏–≤–µ—Ç": `üåü **–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ú–∏—Ç–∞ ‚Äî —Ç–≤–æ–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.**

–Ø –ø–æ–º–æ–≥–∞—é –≤ –æ—Å–≤–æ–µ–Ω–∏–∏ **Python** (–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ) –∏ **Figma** (–¥–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤). üöÄ

–Ø —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ–º –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö ‚Äî –æ—Ç –Ω–æ–≤–∏—á–∫–∞ –¥–æ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è.

üêç **–ü–æ–º–æ—â—å –ø–æ Python:**
‚Ä¢ –û—Å–Ω–æ–≤—ã –∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
‚Ä¢ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —Ü–∏–∫–ª—ã (for, while), —É—Å–ª–æ–≤–∏—è (if)
‚Ä¢ –°–ø–∏—Å–∫–∏, —Å–ª–æ–≤–∞—Ä–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
‚Ä¢ –§—É–Ω–∫—Ü–∏–∏ –∏ –û–û–ü (–∫–ª–∞—Å—Å—ã)
‚Ä¢ –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫ –≤ –∫–æ–¥–µ –∏ –µ–≥–æ —Ä–∞–∑–±–æ—Ä

üé® **–ü–æ–º–æ—â—å –ø–æ Figma:**
‚Ä¢ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Ä–∞–±–æ—Ç–∞ —Å–æ —Å–ª–æ—è–º–∏
‚Ä¢ –ü—Ä–∏–Ω—Ü–∏–ø—ã UI/UX –¥–∏–∑–∞–π–Ω–∞
‚Ä¢ –ê–≤—Ç–æ-–ª–µ–π–∞—É—Ç—ã –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚Ä¢ –°–µ—Ç–∫–∏, —Ü–≤–µ—Ç–∞ –∏ —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞
‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –º–∞–∫–µ—Ç–æ–≤ —Å–∞–π—Ç–æ–≤ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

–ü–∏—à–∏—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å, –Ω–∞–ø—Ä–∏–º–µ—Ä: *¬´–û–±—ä—è—Å–Ω–∏ —Ü–∏–∫–ª—ã¬ª*, *¬´–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∫–Ω–æ–ø–∫—É –≤ Figma?¬ª* –∏–ª–∏ *¬´–Ø –Ω–æ–≤–∏—á–æ–∫, —Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å?¬ª*. –ù–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ ‚Äî –∏ —è –ø–æ–º–æ–≥—É! ‚ú®`,
            "–∫–∞–∫ –¥–µ–ª–∞": "–£ –º–µ–Ω—è –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ! –Ø –Ω–∞ —Å—Ç—Ä–∞–∂–µ —Ç–≤–æ–µ–≥–æ –æ–±—É—á–µ–Ω–∏—è. –û —á–µ–º —Ö–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è? –Ø –≥–æ—Ç–æ–≤–∞ —Ä–∞–∑–æ–±—Ä–∞—Ç—å –∫–æ–¥ –Ω–∞ Python –∏–ª–∏ –ø–æ–º–æ—á—å —Å –º–∞–∫–µ—Ç–æ–º –≤ Figma! üòä",
            "–∫—Ç–æ —Ç–≤–æ–π —Å–æ–∑–¥–∞—Ç–µ–ª—å": "–ú–æ–∏–º —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º —è–≤–ª—è–µ—Ç—Å—è –î–∞–Ω–∏—è–ª.",
            "–∫—Ç–æ —Ç–µ–±—è —Å–æ–∑–¥–∞–ª": "–ú–æ–∏–º —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º —è–≤–ª—è–µ—Ç—Å—è –î–∞–Ω–∏—è–ª.",
            "—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å": "–Ø –ø–æ–º–æ–≥–∞—é –∏–∑—É—á–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Python –∏ –¥–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –≤ Figma.",
            "—Ç—ã —É—á–∏—Ç–µ–ª—å": "–Ø –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.",
            "–ø–æ–º–æ–≥–∏": "–ö–æ–Ω–µ—á–Ω–æ. –ù–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ.",
            "—è –Ω–æ–≤–∏—á–æ–∫": "–û—Ç–ª–∏—á–Ω–æ! –ù–∞—á–Ω–µ–º —Å –æ—Å–Ω–æ–≤. Python –∏–ª–∏ Figma?",
            "—è –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–Ω–∏–º–∞—é": "–ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π—Ç–µ. –û–±—ä—è—Å–Ω—é –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ.",
            "—á—Ç–æ —Ç–∞–∫–æ–µ python": "–≠—Ç–æ —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–æ—Å—Ç–æ–π –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è.",
            "—á—Ç–æ —Ç–∞–∫–æ–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è": "–≠—Ç–æ –∏–º—è, –∫–æ—Ç–æ—Ä–æ–µ —Ö—Ä–∞–Ω–∏—Ç –∑–Ω–∞—á–µ–Ω–∏–µ.",
            "—á—Ç–æ —Ç–∞–∫–æ–µ —Ü–∏–∫–ª": "–≠—Ç–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π.",
            "—á—Ç–æ —Ç–∞–∫–æ–µ —Ñ—É–Ω–∫—Ü–∏—è": "–≠—Ç–æ –±–ª–æ–∫ –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞—á—É.",
            "—á—Ç–æ –¥–µ–ª–∞–µ—Ç if": "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ª–æ–≤–∏–µ.",
            "—á—Ç–æ —Ç–∞–∫–æ–µ —Å–ø–∏—Å–æ–∫": "–≠—Ç–æ –Ω–∞–±–æ—Ä –∑–Ω–∞—á–µ–Ω–∏–π –≤ –æ–¥–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ.",
            "–æ—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ": "–ü—Ä–∏—à–ª–∏—Ç–µ –∫–æ–¥ ‚Äî –ø–æ–º–æ–≥—É –Ω–∞–π—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É.",
            "–∫–∞–∫ –Ω–∞—á–∞—Ç—å": "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ print(\"Hello\").",
            "—á—Ç–æ —Ç–∞–∫–æ–µ –∞–ª–≥–æ—Ä–∏—Ç–º": "–≠—Ç–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —à–∞–≥–æ–≤ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏.",
            "—á—Ç–æ —Ç–∞–∫–æ–µ –æ–æ–ø": "–≠—Ç–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–ª–∞—Å—Å–æ–≤ –∏ –æ–±—ä–µ–∫—Ç–æ–≤.",
            "–∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∏–≥—Ä—É": "–ù–∞—á–Ω–∏—Ç–µ —Å –ª–æ–≥–∏–∫–∏ –∏ —É—Å–ª–æ–≤–∏–π.",
            "–∫–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ñ–∞–π–ª–∞–º–∏": "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è open().",
            "—á—Ç–æ —Ç–∞–∫–æ–µ —Ü–∏–∫–ª for": "–¶–∏–∫–ª –¥–ª—è –ø–µ—Ä–µ–±–æ—Ä–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤.",
            "—á—Ç–æ —Ç–∞–∫–æ–µ while": "–¶–∏–∫–ª, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –ø–æ–∫–∞ —É—Å–ª–æ–≤–∏–µ –∏—Å—Ç–∏–Ω–Ω–æ.",
            "—á—Ç–æ —Ç–∞–∫–æ–µ —Å–ª–æ–≤–∞—Ä—å": "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö ¬´–∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ¬ª.",
            "—á—Ç–æ —Ç–∞–∫–æ–µ figma": "–≠—Ç–æ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏–∑–∞–π–Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤.",
            "–∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∫–Ω–æ–ø–∫—É": "–ù–∞—Ä–∏—Å—É–π—Ç–µ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç.",
            "—á—Ç–æ —Ç–∞–∫–æ–µ auto layout": "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤.",
            "—á—Ç–æ —Ç–∞–∫–æ–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç": "–ü–æ–≤—Ç–æ—Ä–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–∏–∑–∞–π–Ω–∞.",
            "—á—Ç–æ —Ç–∞–∫–æ–µ ui": "–í–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.",
            "—á—Ç–æ —Ç–∞–∫–æ–µ ux": "–£–¥–æ–±—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.",
            "–∫–∞–∫ –≤—ã—Ä–æ–≤–Ω—è—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã Align.",
            "—á—Ç–æ —Ç–∞–∫–æ–µ —Ñ—Ä–µ–π–º": "–†–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å —ç–∫—Ä–∞–Ω–∞.",
            "–∫–∞–∫ –≤—ã–±—Ä–∞—Ç—å —Ü–≤–µ—Ç": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ü–≤–µ—Ç–æ–≤—É—é –ø–∞–Ω–µ–ª—å.",
            "—á—Ç–æ —Ç–∞–∫–æ–µ —Å–µ—Ç–∫–∞": "–ü–æ–º–æ–≥–∞–µ—Ç –≤—ã—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã.",
            "–¥–∞–π –∑–∞–¥–∞–Ω–∏–µ": "–í–æ—Ç –ø—Ä–∞–∫—Ç–∏–∫–∞ –ø–æ —Ç–µ–º–µ.",
            "–ø—Ä–æ–≤–µ—Ä—å –∫–æ–¥": "–ü—Ä–∏—à–ª–∏—Ç–µ –µ–≥–æ.",
            "–æ–±—ä—è—Å–Ω–∏ –ø—Ä–æ—â–µ": "–°–µ–π—á–∞—Å –æ–±—ä—è—Å–Ω—é –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ.",
            "—è —Å–¥–µ–ª–∞–ª –æ—à–∏–±–∫—É": "–û—à–∏–±–∫–∏ ‚Äî —á–∞—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è.",
            "—Å–ª–æ–∂–Ω–æ": "–†–∞–∑–±–µ—Ä–µ–º –ø–æ —à–∞–≥–∞–º.",
            "–±—ã—Å—Ç—Ä–µ–µ": "–î–∞–º –∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ.",
            "–º–µ–¥–ª–µ–Ω–Ω–æ": "–ü–æ–¥—Ä–æ–±–Ω–æ –æ–±—ä—è—Å–Ω—é –∫–∞–∂–¥—ã–π —à–∞–≥.",
            "—É –º–µ–Ω—è –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è": "–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –≤—ã —É—á–∏—Ç–µ—Å—å.",
            "—è —É—Å—Ç–∞–ª": "–°–¥–µ–ª–∞–π—Ç–µ –ø–µ—Ä–µ—Ä—ã–≤ –∏ –ø—Ä–æ–¥–æ–ª–∂–∏–º.",
            "—ç—Ç–æ —Ç—Ä—É–¥–Ω–æ": "–° –ø—Ä–∞–∫—Ç–∏–∫–æ–π —Å—Ç–∞–Ω–µ—Ç –ª–µ–≥—á–µ."
        };
    }

    /**
     * Get provider by model name
     */
    getProvider(model) {
        return this.providers.gemini;
    }

    /**
     * Main method to generate AI response
     */
    async chat({
        message,
        history = [],
        mode = 'tutor',
        model = AI_CONFIG.DEFAULT_MODEL,
        options = {}
    }) {
        const startTime = Date.now();
        const lowerMessage = message.toLowerCase();

        // 1. Check for ready static responses (EXPERT_KNOWLEDGE)
        for (const [key, text] of Object.entries(this.EXPERT_KNOWLEDGE)) {
            if (lowerMessage.includes(key)) {
                return {
                    success: true,
                    reply: text,
                    usage: { model: 'static-knowledge', inputTokens: 0, outputTokens: 0, latencyMs: Date.now() - startTime }
                };
            }
        }

        // 2. Fallback to Gemini AI
        try {
            const provider = this.getProvider(model);
            const systemInstruction = MITA_PERSONALITY.basePrompt(mode);

            const result = await provider.generateResponse({
                model,
                systemInstruction,
                history,
                message,
                options
            });

            return {
                success: true,
                reply: result.text,
                usage: {
                    model,
                    ...result.usage,
                    latencyMs: Date.now() - startTime
                }
            };
        } catch (error) {
            console.error('AIService Error:', error);

            const isRateLimit = error.message?.includes('429') || error.message?.includes('RESOURCE_EXHAUSTED');

            if (isRateLimit) {
                return {
                    success: false,
                    reply: "–ò–∑–≤–∏–Ω–∏—Ç–µ, —Å–µ–π—á–∞—Å —è –Ω–µ–º–Ω–æ–≥–æ –∑–∞–Ω—è—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É!"
                };
            }

            return {
                success: false,
                reply: "–ò–∑–≤–∏–Ω–∏—Ç–µ, —É –º–µ–Ω—è –≤–æ–∑–Ω–∏–∫–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            };
        }
    }
}

export const aiService = new AIService();
