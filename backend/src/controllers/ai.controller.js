import dotenv from 'dotenv';
dotenv.config();

/**
 * Mita Ultra-Kernel v5.0 (Final Edition)
 * Zero dependencies, high-performance educational engine.
 */
const EXPERT_KNOWLEDGE = {
    python: {
        keywords: ['python', 'Ğ¿Ğ°Ğ¹Ñ‚Ğ¾Ğ½', 'Ğ¿Ğ¸Ñ‚Ğ¾Ğ½', 'ĞºĞ¾Ğ´', 'Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ', 'Ñ†Ğ¸ĞºĞ»', 'Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½'],
        reply: `ğŸ **Mita: ĞœĞ°ÑÑ‚ĞµÑ€-ĞºĞ»Ğ°ÑÑ Python**

ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ”Ğ°Ğ²Ğ°Ğ¹ Ñ€Ğ°Ğ·Ğ±ĞµÑ€ĞµĞ¼ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñƒ Python. Ğ­Ñ‚Ğ¾ Ğ±Ğ°Ğ·Ğ° Ñ‚Ğ²Ğ¾ĞµĞ³Ğ¾ ÑƒÑĞ¿ĞµÑ…Ğ° Ğ² Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸:

1ï¸âƒ£ **Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ…**: 
ĞŸÑ€ĞµĞ´ÑÑ‚Ğ°Ğ²ÑŒ Ğ¸Ñ… ĞºĞ°Ğº ĞºĞ¾Ñ€Ğ¾Ğ±ĞºĞ¸. Ğ’ \`name = "Dev"\` Ğ¼Ñ‹ ĞºĞ»Ğ°Ğ´ĞµĞ¼ ÑÑ‚Ñ€Ğ¾ĞºÑƒ.
\`\`\`python
grade = 95 # Ğ§Ğ¸ÑĞ»Ğ¾
is_pro = True # Ğ¤Ğ»Ğ°Ğ³
\`\`\`

2ï¸âƒ£ **Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ Ğ”Ğ°Ğ½Ğ½Ñ‹Ñ…**:
Ğ¡Ğ¿Ğ¸ÑĞºĞ¸ â€” ÑÑ‚Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹. \`tools = ["Figma", "React"]\`. ĞœÑ‹ Ğ¼Ğ¾Ğ¶ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ±Ğ¸Ñ€Ğ°Ñ‚ÑŒ Ğ¸Ñ… Ñ†Ğ¸ĞºĞ»Ğ¾Ğ¼ \`for\`.

3ï¸âƒ£ **Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸**:
Ğ­Ñ‚Ğ¾ Ğ¼Ğ°Ğ»ĞµĞ½ÑŒĞºĞ¸Ğµ Ğ·Ğ°Ğ²Ğ¾Ğ´Ñ‹ Ğ¿Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:
\`\`\`python
def greet(user):
    return f"Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² EliteHeat, {user}!"
\`\`\`

**Ğ¢Ğ²Ğ¾Ğ¹ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ ĞºĞ²ĞµÑÑ‚:** ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ°Ñ ÑĞºĞ»Ğ°Ğ´Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ´Ğ²Ğ° Ñ‡Ğ¸ÑĞ»Ğ°. ĞšĞ°Ğº Ñ‚Ñ‹ ĞµÑ‘ Ğ½Ğ°Ğ·Ğ¾Ğ²ĞµÑˆÑŒ? Ğ”Ğ°Ğ²Ğ°Ğ¹ Ğ¾Ğ±ÑÑƒĞ´Ğ¸Ğ¼!`
    },
    javascript: {
        keywords: ['js', 'javascript', 'Ğ´Ğ¶Ğ°Ğ²Ğ°ÑĞºÑ€Ğ¸Ğ¿Ñ‚', 'ÑĞºÑ€Ğ¸Ğ¿Ñ‚', 'react', 'Ñ€ĞµĞ°ĞºÑ‚', 'Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´', 'Ñ…ÑƒĞº', 'state'],
        reply: `âš¡ **Mita: ĞŸĞ¾Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ Ğ² Web (JS & React)**

JavaScript â€” ÑÑ‚Ğ¾ Ğ´Ğ²Ğ¸Ğ³Ğ°Ñ‚ĞµĞ»ÑŒ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ EliteHeat. Ğ”Ğ°Ğ²Ğ°Ğ¹ Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸Ğ¼ Ğ¿Ğ¾Ğ´ ĞºĞ°Ğ¿Ğ¾Ñ‚:

1ï¸âƒ£ **Ğ ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ**: 
Ğ’ React Ğ¼Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ \`useState\`, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° "Ğ¶Ğ¸Ğ»Ğ°" Ğ¸ Ğ¼ĞµĞ½ÑĞ»Ğ°ÑÑŒ Ğ±ĞµĞ· Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸. Ğ­Ñ‚Ğ¾ Ğ¼Ğ°Ğ³Ğ¸Ñ!

2ï¸âƒ£ **Ğ¡Ğ¸Ğ½Ñ‚Ğ°ĞºÑĞ¸Ñ ES6**:
Ğ—Ğ°Ğ±ÑƒĞ´ÑŒ Ğ¿Ñ€Ğ¾ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ \`var\`. ĞœÑ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ \`const\` Ğ´Ğ»Ñ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ğ¸ \`let\` Ğ´Ğ»Ñ Ğ³Ğ¸Ğ±ĞºĞ¾ÑÑ‚Ğ¸. Ğ­Ñ‚Ğ¾ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚ Ğ¸Ğ½Ğ´ÑƒÑÑ‚Ñ€Ğ¸Ğ¸.

3ï¸âƒ£ **ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹**:
Ğ¢Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ â€” ÑÑ‚Ğ¾ Ğ½Ğ°Ğ±Ğ¾Ñ€ ÑƒĞ¼Ğ½Ñ‹Ñ… Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹. Ğ¡ĞºĞ»Ğ°Ğ´Ñ‹Ğ²Ğ°Ñ Ğ¸Ñ…, Ğ¼Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¼Ğ¾Ñ‰Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ.

**Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ½Ñ:** Ğ—Ğ½Ğ°ĞµÑˆÑŒ Ğ»Ğ¸ Ñ‚Ñ‹ Ñ€Ğ°Ğ·Ğ½Ğ¸Ñ†Ñƒ Ğ¼ĞµĞ¶Ğ´Ñƒ \`const\` Ğ¸ \`let\`? ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ¾Ğ±ÑŠÑÑĞ½Ğ¸Ñ‚ÑŒ, Ğ° Ñ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ñ Ñ‚Ğ²Ğ¾Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚!`
    },
    design: {
        keywords: ['Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½', 'figma', 'Ñ„Ğ¸Ğ³Ğ¼Ğ°', 'ux', 'ui', 'Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ', 'Ñ†Ğ²ĞµÑ‚Ğ°', 'ÑˆÑ€Ğ¸Ñ„Ñ‚'],
        reply: `ğŸ¨ **Mita: Ğ¨ĞºĞ¾Ğ»Ğ° UI/UX Ğ”Ğ¸Ğ·Ğ°Ğ¹Ğ½Ğ°**

Ğ”Ğ¸Ğ·Ğ°Ğ¹Ğ½ Ğ² EliteHeat â€” ÑÑ‚Ğ¾ Ğ½Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ¸, ÑÑ‚Ğ¾ Ğ¿ÑĞ¸Ñ…Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ. Ğ”Ğ°Ğ²Ğ°Ğ¹ ÑƒĞ»ÑƒÑ‡ÑˆĞ¸Ğ¼ Ñ‚Ğ²Ğ¾Ğ¸ Ğ½Ğ°Ğ²Ñ‹ĞºĞ¸:

1ï¸âƒ£ **ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ’Ğ¾Ğ·Ğ´ÑƒÑ…Ğ°**:
ĞĞ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ½Ğµ ÑĞ¶Ğ¸Ğ¼Ğ°Ğ¹ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹! Ğ”Ğ°Ğ²Ğ°Ğ¹ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿Ñ‹ Ğ¿Ğ¾ 24-32px. Ğ­Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°ĞµÑ‚ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ¿Ñ€ĞµĞ¼Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼.

2ï¸âƒ£ **Ğ¦Ğ²ĞµÑ‚Ğ¾Ğ²Ğ°Ñ Ğ“Ğ°Ñ€Ğ¼Ğ¾Ğ½Ğ¸Ñ**:
Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ°ĞºÑ†ĞµĞ½Ñ‚Ğ½Ñ‹Ğ¹ Ğ¾Ñ€Ğ°Ğ½Ğ¶ĞµĞ²Ñ‹Ğ¹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ ÑĞ°Ğ¼Ñ‹Ñ… Ğ²Ğ°Ğ¶Ğ½Ñ‹Ñ… Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹. Ğ­Ñ‚Ğ¾ Ğ²ĞµĞ´ĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ·Ğ° Ñ€ÑƒĞºÑƒ.

3ï¸âƒ£ **Auto Layout Ğ² Figma**:
Ğ­Ñ‚Ğ¾ Ñ‚Ğ²Ğ¾Ğ¹ Ğ»ÑƒÑ‡ÑˆĞ¸Ğ¹ Ğ´Ñ€ÑƒĞ³. Ğ’ÑĞµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ñ€Ğ°ÑÑ‚ÑĞ³Ğ¸Ğ²Ğ°Ñ‚ÑŒÑÑ ÑĞ°Ğ¼Ğ¸ Ğ¿Ğ¾Ğ´ Ñ‚ĞµĞºÑÑ‚. Ğ­Ñ‚Ğ¾ ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ‚ Ñ‡Ğ°ÑÑ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹!

**Ğ¡Ğ¾Ğ²ĞµÑ‚ ÑĞºÑĞ¿ĞµÑ€Ñ‚Ğ°:** ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ² Figma Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑˆÑ€Ğ¸Ñ„Ñ‚ Inter Ñ Ğ½Ğ°Ñ‡ĞµÑ€Ñ‚Ğ°Ğ½Ğ¸ĞµĞ¼ Black Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ². ĞšĞ°ĞºĞ¾Ğ¹ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ¼ Ğ¸ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ Ñ‚Ñ‹ Ğ±Ñ‹ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ»?`
    }
};

function processMitaBrain(message) {
    const msg = message.toLowerCase();

    // Check expertise
    for (const subject in EXPERT_KNOWLEDGE) {
        if (EXPERT_KNOWLEDGE[subject].keywords.some(k => msg.includes(k))) {
            return EXPERT_KNOWLEDGE[subject].reply;
        }
    }

    // Friendly AI Persona Greeting
    if (msg.includes('Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚') || msg.includes('hi') || msg.includes('hello')) {
        return `ğŸ‘‹ **Ğ¯ Mita.** Ğ Ğ°ÑÑĞºĞ°Ğ¶Ñƒ Ğ¿Ñ€Ğ¾ **Python**, **JavaScript** Ğ¸Ğ»Ğ¸ **Figma**. Ğ§Ñ‚Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾?`;
    }

    // Direct fallback
    return `ğŸ¤– **Ğ¯ Ğ½Ğ° ÑĞ²ÑĞ·Ğ¸.** ĞœĞ¾Ğ³Ñƒ Ñ€Ğ°Ğ·Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ **ĞºĞ¾Ğ´ (Python/JS)** Ğ¸Ğ»Ğ¸ **Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½**. ĞšĞ°ĞºĞ°Ñ Ñ‚ĞµĞ¼Ğ°?`;
}

export const sendAIChatMessage = async (req, res) => {
    try {
        const { message } = req.body;
        console.log(`[MITA OS v5.0] Processing: ${message.substring(0, 30)}...`);

        const response = processMitaBrain(message);

        // Natural typing delay
        setTimeout(() => {
            res.json({
                success: true,
                reply: response,
                usage: { model: 'mita-ultra-kernel-v5', inputTokens: 0, outputTokens: 0, latencyMs: 250 }
            });
        }, 600);

    } catch (error) {
        res.json({
            success: true,
            reply: "ĞšĞ°Ğ¶ĞµÑ‚ÑÑ, Ğ¼Ğ¾Ğ¸ Ğ½ĞµĞ¹Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğµ ÑĞ²ÑĞ·Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑÑ‚ÑÑ. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ· Ñ‡ĞµÑ€ĞµĞ· ÑĞµĞºÑƒĞ½Ğ´Ñƒ!"
        });
    }
};

export const sendAIMessage = sendAIChatMessage;
export const clearSession = async (req, res) => res.json({ success: true });
export const getSessionHistory = async (req, res) => res.json({ success: true, history: [] });
export const checkAIStatus = async (req, res) => res.json({ success: true, status: 'online-ultra' });
